/**
 * @file
 * Written by Henri MEDOT <henri.medot[AT]absyx[DOT]fr>
 * http://www.absyx.fr
 */

!function(e){"use strict";var i=0,t=function(e){if(1024>e)return Drupal.formatPlural(e,"1 byte","@count bytes");e/=1024;var i,t,n,a=[Drupal.t("@size KB"),Drupal.t("@size MB"),Drupal.t("@size GB")];for(t=0,n=a.length;n>t&&(i=Math.round(100*e)/100,1024<=i);t++)e/=1024;return a[t].replace("@size",i)},n=function(i){var t=2,n="";return e.each([86400,3600,60,1],function(e,a){if(i>=a){var l=Math.floor(i/a),r=0==e?Drupal.formatPlural(l,"1 day","@count days"):1==e?Drupal.formatPlural(l,"1 hour","@count hours"):2==e?Drupal.formatPlural(l,"1 min","@count min"):Drupal.formatPlural(l,"1 sec","@count sec");n+=(n?" ":"")+r,i%=a,t--}return t?void 0:!1}),n?n:Drupal.t("0 sec")},a=function(i,n){if(e(".file-list",n).remove(),i.files.length){var r=e('<ul class="file-list"></ul>');e.each(i.files,function(s,o){var d=e('<a href="#" class="remove"><span>(-)</span></a>').attr("title",Drupal.t("Remove file")).click(function(e){l(n.parent()),i.removeFile(o),a(i,n),e.preventDefault()});r.append(e("<li>"+Drupal.checkPlain(o.name)+" <strong>("+t(o.size)+")</strong></li>").prepend(d))}),n.prepend(r)}n.siblings(".button.browse").toggleClass("disabled",!o(i)),s(n.siblings(".button.upload"),i)},l=function(i){e(".file-upload-js-error",i).remove()},r=function(i,t){var n=e(".file-upload-js-error",i);if(n.length){var a=n.children("ul");a.length?a.append("<li>"+t+"</li>"):n.html("<ul><li>"+n.html()+"</li><li>"+t+"</li></ul>")}else i.prepend('<div class="messages error file-upload-js-error">'+t+"</div>")},s=function(e,i){var t=i.uploading;e.html("<span>"+Drupal.t(t?"Cancel":"Upload")+"</span>").toggleClass("cancel",t).toggleClass("disabled",!i.files.length)},o=function(e){var i=e.options.maxFiles;return!i||1==i||e.files.length<i},d=function(){return(new Date).getTime()};Drupal.behaviors.fileResup={attach:function(u,f){e(".file-resup",u).once("file-resup",function(){this.id="file-resup-"+i++;var u,p,c,m,h=e(this).val(""),g=h.closest(".file-resup-wrapper");if(!Resup.support)return h.attr("disabled","disabled"),void g.hide();var v=e('input[name="'+h.data("upload-name")+'"]').hide(),b=e('[name="'+h.data("upload-button-name")+'"]').hide();Drupal.ajax[b.attr("id")].progress.type="none";var w=g.closest(".form-item");w.find(".description:first").html(h.data("description"));var x=h.data("max-files");if(1!=x){var z=w.find("label:first");e.trim(z.text())==Drupal.t("Add a new file")&&z.text(Drupal.t("Add new files"))}var y=e('<div class="item-list drop"><div class="drop-message">'+h.data("drop-message")+"</div></div>").bind("drop",function(e){o(k)&&l(g),e.preventDefault()}).appendTo(g),D=h.data("max-filesize"),P=h.data("extensions").split(","),k=new Resup(h.data("url"),{chunkSize:f.file_resup.chunk_size,maxFiles:x,maxFileSize:D,extensions:P,query:{form_build_id:e('input[name="form_build_id"]',this.form).val()},fileValidator:function(e){return e.name.length>240?void r(g,Drupal.t("File name %filename exceeds the 240 characters limit.",{"%filename":e.name})):!0},drop:y.get(0)}),F=e(k.input).addClass("element-invisible");e('<a href="#" class="button browse"><span>'+Drupal.t("Browse")+"</span></a>").click(function(e){o(k)&&(l(g),F.click()),e.preventDefault()}).appendTo(g).after(F);var j=e('<a href="#" class="button upload disabled"><span>'+Drupal.t("Upload")+"</span></a>").click(function(e){p||(k.uploading?(k.stop(),u.element.hide(),s(j,k)):k.files.length&&(l(g),u||(u=new Drupal.progressBar("ajax-progress-"+h.attr("id")),y.after(u.element)),u.setProgress(0,Drupal.t("Starting upload...")),u.element.show(),m=0,k.retry(),s(j,k))),e.preventDefault()}).appendTo(g);k.onresupaddedfileerror=function(e,i){r(g,"size"==i?e.size?Drupal.t("File %filename is %filesize, exceeding the maximum file size of %maxsize.",{"%filename":e.name,"%filesize":t(e.size),"%maxsize":t(D)}):Drupal.t("File %filename is empty. Empty files cannot be uploaded.",{"%filename":e.name}):Drupal.t("File %filename cannot be uploaded. Only files with the following extensions are allowed: %extensions.",{"%filename":e.name,"%extensions":P.join(", ")}))},k.onresupfilesadded=function(i,t){var n=e(".file-upload-js-error",g).length;t>1&&n&&r(g,Drupal.t("@count files in total were skipped.",{"@count":t})),i.length&&(a(k,y),k.uploading||n||!h.data("autostart")||j.click())},k.onresupprogress=function(){var e=k.getProgress();if(e){if(1>e){m||(c=Drupal.t("Uploading..."));var i,t=d();t-m>999&&(m=t,i=k.getTime(),i>-1&&(c=Drupal.t("Uploading... (@time remaining)",{"@time":n(i)})))}else c=Drupal.t("Completing upload...");u.setProgress((Math.round(1e3*e)/10).toFixed(1),c)}},k.onresupended=function(i){if(i.length){p=!0,j.addClass("disabled");var t=[];e.each(i,function(e,i){t.push(i.id)}),h.val(t.join(",")),v.attr("disabled","disabled"),b.mousedown()}else u.element.hide()},k.onresupfileerror=function(e){k.stop(),u.element.hide(),s(j,k),r(g,Drupal.t("An error occurred while uploading file %filename. Please click <em>Upload</em> to retry.",{"%filename":e.name}))},e(this.form).bind("submit."+this.id,function(e){return k.uploading||p?(alert(Drupal.t("Files are currently being uploaded. Please stand by...")),e.stopImmediatePropagation(),!1):void 0}),e(window).bind("beforeunload."+this.id,function(){k.stop()})})},detach:function(i,t,n){"unload"==n&&e(".file-resup",i).each(function(){var i="."+this.id;e(this.form).unbind(i),e(window).unbind(i)})}}}(jQuery);